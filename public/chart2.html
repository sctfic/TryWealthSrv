<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Visualisation de données boursières</title>
    <style>
        .container { margin: 20px; }
        .axis path { stroke: #555; }
        .grid line { stroke: #eee; }
        .line { 
            fill: none; 
            stroke: steelblue; 
            stroke-width: 1.5; /* Ligne plus fine */
        }
        .dividends-line {
            stroke: #ff9900;
            stroke-width: 1;
        }
        .overlay { fill: none; pointer-events: all; }
        .candlestick-cursor { 
            stroke-width: 2;
            pointer-events: none;
        }
        .ohlc-text { 
            font-size: 10px; 
            fill: #333;
            font-family: Arial;
        }
        .axis-right text {
            fill: #ff9900; /* Couleur correspondante aux dividends */
        }
    </style>
</head>
<body>
    <div class="container">
        <select id="series-select" class="series-selector">
            <option value="Open">Open</option>
            <option value="Close" selected>Close</option>
            <option value="High">High</option>
            <option value="Low">Low</option>
        </select>
        <div id="chart"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const width = window.innerWidth * 0.9;
        const height = 500;
        const margin = { top: 20, right: 50, bottom: 40, left: 50 }; // Augmentation de la marge droite

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Échelles
        const xScale = d3.scaleTime().range([0, width - margin.left - margin.right]);
        const yScaleLeft = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);
        const yScaleRight = d3.scaleLinear().range([height - margin.top - margin.bottom, 0]);

        // Groupe pour le curseur chandelle (ajouté APRÈS la courbe principale)
        const focus = svg.append("g")
            .attr("class", "focus")
            .style("display", "none");

        // ... (éléments du candlestick identiques) ...

        d3.csv("http://localhost/static/test.csv").then(data => {
            const parseTime = d3.timeParse("%Y-%m-%d %H:%M:%S");
            
            data.forEach(d => {
                d.Datetime = parseTime(d.Datetime.substring(0, 19));
                d.Open = +d.Open;
                d.High = +d.High;
                d.Low = +d.Low;
                d.Close = +d.Close;
                d.Dividends = +d.Dividends; // Assurez-vous que cette colonne existe
            });

            // Mise à jour des domaines
            xScale.domain(d3.extent(data, d => d.Datetime));
            yScaleLeft.domain([d3.min(data, d => d.Low), d3.max(data, d => d.High)]);
            yScaleRight.domain([0, d3.max(data, d => d.Dividends)]); // Domaine pour les dividends

            // Courbe principale
            const mainLine = d3.line()
                .x(d => xScale(d.Datetime))
                .y(d => yScaleLeft(d.Close))
                .curve(d3.curveMonotoneX);

            // Courbe des dividends
            const dividendsLine = d3.line()
                .x(d => xScale(d.Datetime))
                .y(d => yScaleRight(d.Dividends))
                .curve(d3.curveMonotoneX);

            // Dessin des courbes
            svg.append("path")
                .datum(data)
                .attr("class", "line")
                .attr("d", mainLine);

            svg.append("path")
                .datum(data)
                .attr("class", "dividends-line")
                .attr("d", dividendsLine);

            // Axes
            svg.append("g")
                .attr("class", "axis axis--x grid")
                .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(xScale).ticks(5));

            svg.append("g")
                .attr("class", "axis axis--y grid")
                .call(d3.axisLeft(yScaleLeft).ticks(5));

            svg.append("g") // Axe droit pour les dividends
                .attr("class", "axis axis-right")
                .attr("transform", `translate(${width - margin.left - margin.right},0)`)
                .call(d3.axisRight(yScaleRight).ticks(5));

            // ... (reste du code identique pour les interactions et le zoom) ...

            // Modification de la fonction de zoom
            const zoom = d3.zoom()
                .scaleExtent([1, 10])
                .on("zoom", (event) => {
                    const newXScale = event.transform.rescaleX(xScale);
                    const newYScale = event.transform.rescaleY(yScaleLeft);

                    xScale.domain(newXScale.domain());
                    yScaleLeft.domain(newYScale.domain());

                    // Mise à jour des courbes
                    svg.select(".line").attr("d", mainLine.x(d => xScale(d.Datetime)).y(d => yScaleLeft(d.Close)));
                    svg.select(".dividends-line").attr("d", dividendsLine.x(d => xScale(d.Datetime)));

                    // Mise à jour des axes
                    svg.select(".axis--x").call(d3.axisBottom(xScale));
                    svg.select(".axis--y").call(d3.axisLeft(yScaleLeft));
                });

            // Déplacement du groupe focus en premier plan
            svg.node().appendChild(focus.node());
        });
    </script>
</body>
</html>